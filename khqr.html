<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bakong KHQR & Transaction Simulator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
    <!-- React CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel CDN for JSX transformation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="min-h-screen bg-gray-100 flex items-center justify-center p-4">
    <div id="root"></div>

    <script type="text/babel">
        // Main App component
        const App = () => {
            const [activeTab, setActiveTab] = React.useState('generate');
            const [accessToken, setAccessToken] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [message, setMessage] = React.useState('');

            // ** IMPORTANT: For demonstration only. In a real application, store this securely on a backend server. **
            const API_KEY = 'cba8c35e352d435b9ef3'; // Your provided API key
            const USER_PROVIDED_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjp7ImlkIjoiNTcwYjYyYmQ3OTI3NGQzYyJ9LCJpYXQiOjE3NTI4MDc0MDYsImV4cCI6MTc2MDU4MzQwNn0.xsjK_KIHKAsXz-XdouhFNzN_ETuuW1s8aVjdiCj4HHg';
            
            // !!! BAKONG API BASE URL - Set based on official documentation !!!
            const BAKONG_BASE_URL = 'https://api-bakong.nbc.gov.kh'; 

            // State for KHQR Generation
            const [amount, setAmount] = React.useState('10.00');
            const [currency, setCurrency] = React.useState('KHR');
            const [description, setDescription] = React.useState('Payment for goods');
            const [merchantName, setMerchantName] = React.useState('My Shop');
            const [khqrImage, setKhqrImage] = React.useState('');

            // State for Check Bakong Account
            const [accountId, setAccountId] = React.useState('user@bank');
            const [accountCheckResult, setAccountCheckResult] = React.useState(null);

            // State for Auto Transaction
            const [transactionRecipient, setTransactionRecipient] = React.useState('recipient@bank');
            const [transactionAmount, setTransactionAmount] = React.useState('5.00');
            const [transactionResult, setTransactionResult] = React.useState(null);

            // Set access token synchronously on initial load
            React.useEffect(() => {
                console.log('useEffect: Setting access token directly from USER_PROVIDED_TOKEN');
                setAccessToken(USER_PROVIDED_TOKEN);
                setMessage('Ready to use! Remember to secure your real API key and token on a backend!');
                setLoading(false); // Ensure loading is false after initial setup
            }, []);

            // --- Real Bakong API Functions (Requires BAKONG_BASE_URL to be set and proper CORS/backend proxy) ---

            // Function to generate KHQR (Deeplink)
            const generateKhqr = async () => {
                if (!accessToken) {
                    setMessage('Error: Access token not available. Please wait or refresh.');
                    return;
                }
                if (!BAKONG_BASE_URL) { // Check if the base URL is empty
                    setMessage('Error: BAKONG_BASE_URL is not set. Please provide the actual Bakong API Base URL!');
                    return;
                }

                console.log('generateKhqr: Setting loading to true');
                setLoading(true);
                setMessage('Generating KHQR...');

                try {
                    // Simulate KHQR string generation based on input fields.
                    // In a real scenario, this 'qrString' would be generated by a proper KHQR SDK
                    // or a backend service compliant with KHQR specifications.
                    const simulatedQrString = `00020101021226590009KH.BAKONG0115${merchantName}0208${description}5204${currency}5303${amount}5802KH5908${merchantName}6007PHNOMPEH6304ABCD`;
                    console.log('Simulated KHQR String:', simulatedQrString);

                    // Corrected endpoint as per Bakong API Document
                    const apiUrl = `${BAKONG_BASE_URL}/v1/generate_deeplink_by_qr?key=${API_KEY}`;
                    console.log('Calling API:', apiUrl);

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: JSON.stringify({
                            qr: simulatedQrString, // Send the generated QR string
                            // Add other required parameters as per Bakong API Document for generate_deeplink_by_qr
                            // e.g., 'sourceInfo': { 'appIconUrl': 'https://your-app.com/icon.png' }
                        })
                    });

                    const data = await response.json();
                    console.log('generateKhqr API Response:', data);

                    if (response.ok) {
                        // Assuming the API returns a QR image URL or base64 data
                        // You'll need to adjust this based on Bakong's actual response structure
                        if (data.deeplinkUrl) { // Example: if API returns a deeplink URL
                            // For simplicity, we'll use a placeholder image, as deeplink doesn't directly give QR image
                            setKhqrImage(`https://placehold.co/200x200/000/FFF?text=Deeplink%0AGenerated`);
                            setMessage(`Deeplink generated successfully! Deeplink: ${data.deeplinkUrl}`);
                            console.log('Deeplink URL:', data.deeplinkUrl);
                        } else if (data.qrCodeBase64) { // If they provide base64 QR image
                            setKhqrImage(`data:image/png;base64,${data.qrCodeBase64}`);
                            setMessage('KHQR image generated successfully!');
                        } else {
                            // Fallback if the response structure is unexpected
                            setKhqrImage(`https://placehold.co/200x200/FF0000/FFFFFF?text=QR+Error`);
                            setMessage('KHQR generated, but response format unexpected. Check console.');
                        }
                    } else {
                        setMessage(`Failed to generate KHQR: ${data.responseMessage || 'Unknown error'}`);
                        setKhqrImage('');
                    }
                } catch (error) {
                    console.error('Error generating KHQR:', error);
                    setMessage(`Failed to generate KHQR. Network or CORS error: ${error.message}`);
                    setKhqrImage('');
                } finally {
                    console.log('generateKhqr: Setting loading to false');
                    setLoading(false);
                }
            };

            // Function to check Bakong Account
            const checkBakongAccount = async () => {
                if (!accessToken) {
                    setMessage('Error: Access token not available. Please wait or refresh.');
                    return;
                }
                if (!BAKONG_BASE_URL) { // Check if the base URL is empty
                    setMessage('Error: BAKONG_BASE_URL is not set. Please provide the actual Bakong API Base URL!');
                    return;
                }

                console.log('checkBakongAccount: Setting loading to true');
                setLoading(true);
                setMessage(`Checking account: ${accountId}...`);

                try {
                    const apiUrl = `${BAKONG_BASE_URL}/v1/check_bakong_account?key=${API_KEY}`;
                    console.log('Calling API:', apiUrl);

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: JSON.stringify({ accountId: accountId })
                    });

                    const data = await response.json();
                    console.log('checkBakongAccount API Response:', data);
                    setAccountCheckResult(data);

                    if (response.ok && data.responseCode === 0) {
                        setMessage('Account exists!');
                    } else {
                        setMessage(`Account check failed: ${data.responseMessage || 'Account does not exist or unknown error.'}`);
                    }
                } catch (error) {
                    console.error('Error checking account:', error);
                    setMessage(`Failed to check account. Network or CORS error: ${error.message}`);
                    setAccountCheckResult(null);
                } finally {
                    console.log('checkBakongAccount: Setting loading to false');
                    setLoading(false);
                }
            };

            // Function to simulate performing an auto transaction (as direct API is not in docs)
            const performAutoTransaction = async () => {
                if (!accessToken) {
                    setMessage('Error: Access token not available. Please wait or refresh.');
                    return;
                }
                console.log('performAutoTransaction: Setting loading to true');
                setLoading(true);
                setMessage(`Simulating transaction to ${transactionRecipient} for ${transactionAmount} ${currency}...`);

                // This remains a simulation as Bakong's public API documentation does not detail a direct
                // "auto transaction" endpoint for initiating payments from a third-party application.
                // A real automated payment would likely involve a more complex integration or a specific
                // push payment API if offered by Bakong, often handled on a secure backend.
                setTimeout(() => {
                    const isSuccess = Math.random() > 0.3;
                    const mockResponse = {
                        status: isSuccess ? 'SUCCESS' : 'FAILED',
                        transactionId: isSuccess ? `SIM-TXN-${Date.now()}` : null,
                        message: isSuccess ? 'Simulated transaction completed successfully!' : 'Simulated transaction failed. (This is a simulation, not a real API call).',
                    };
                    setTransactionResult(mockResponse);
                    setMessage(mockResponse.message);
                    console.log('performAutoTransaction: Setting loading to false (after simulation)');
                    setLoading(false);
                }, Math.random() * 1000 + 500); // Simulate network delay
            };

            return (
                <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4 font-sans">
                    <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl border border-gray-200">
                        <h1 className="text-3xl font-bold text-center text-gray-800 mb-6">Bakong KHQR & Transaction Simulator</h1>

                        <div className="mb-4 p-3 rounded-md bg-yellow-100 text-yellow-800 border border-yellow-300 text-center font-medium">
                            <p>
                                <strong>SECURITY WARNING:</strong> Your API key and token are currently embedded directly in this client-side code for demonstration purposes.
                                For a real application, you **must** move these credentials and all Bakong API calls to a secure backend server to prevent unauthorized access.
                            </p>
                            <p className="mt-2">
                                <strong>BAKONG_BASE_URL:</strong> `https://api-bakong.nbc.gov.kh` has been set.
                            </p>
                        </div>

                        <div className="mb-6 flex justify-center space-x-4">
                            <button
                                onClick={() => setActiveTab('generate')}
                                className={`px-6 py-3 rounded-full text-lg font-semibold transition-all duration-300
                                    ${activeTab === 'generate' ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-blue-100'}`}
                            >
                                Generate KHQR
                            </button>
                            <button
                                onClick={() => setActiveTab('checkAccount')}
                                className={`px-6 py-3 rounded-full text-lg font-semibold transition-all duration-300
                                    ${activeTab === 'checkAccount' ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-blue-100'}`}
                            >
                                Check Account
                            </button>
                            <button
                                onClick={() => setActiveTab('autoTransaction')}
                                className={`px-6 py-3 rounded-full text-lg font-semibold transition-all duration-300
                                    ${activeTab === 'autoTransaction' ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-blue-100'}`}
                            >
                                Auto Transaction
                            </button>
                        </div>

                        {loading && (
                            <div className="text-center text-blue-500 font-medium mb-4">
                                Loading... {message}
                            </div>
                        )}
                        {!loading && message && (
                            <div className={`text-center mb-4 p-3 rounded-md ${message.includes('Error') || message.includes('Failed') ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                                {message}
                            </div>
                        )}

                        {/* KHQR Generation Tab */}
                        {activeTab === 'generate' && (
                            <div className="bg-blue-50 p-6 rounded-lg border border-blue-200">
                                <h2 className="text-2xl font-semibold text-blue-800 mb-4">Generate KHQR Code</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    <div>
                                        <label htmlFor="amount" className="block text-gray-700 text-sm font-bold mb-2">Amount:</label>
                                        <input
                                            type="number"
                                            id="amount"
                                            value={amount}
                                            onChange={(e) => setAmount(e.target.value)}
                                            className="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500"
                                            placeholder="e.g., 10.00"
                                        />
                                    </div>
                                    <div>
                                        <label htmlFor="currency" className="block text-gray-700 text-sm font-bold mb-2">Currency:</label>
                                        <select
                                            id="currency"
                                            value={currency}
                                            onChange={(e) => setCurrency(e.target.value)}
                                            className="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500"
                                        >
                                            <option value="KHR">KHR</option>
                                            <option value="USD">USD</option>
                                        </select>
                                    </div>
                                    <div className="md:col-span-2">
                                        <label htmlFor="description" className="block text-gray-700 text-sm font-bold mb-2">Description:</label>
                                        <input
                                            type="text"
                                            id="description"
                                            value={description}
                                            onChange={(e) => setDescription(e.target.value)}
                                            className="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500"
                                            placeholder="e.g., Payment for goods"
                                        />
                                    </div>
                                    <div className="md:col-span-2">
                                        <label htmlFor="merchantName" className="block text-gray-700 text-sm font-bold mb-2">Merchant Name:</label>
                                        <input
                                            type="text"
                                            id="merchantName"
                                            value={merchantName}
                                            onChange={(e) => setMerchantName(e.target.value)}
                                            className="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500"
                                            placeholder="e.g., My Shop"
                                        />
                                    </div>
                                </div>
                                <button
                                    onClick={generateKhqr}
                                    disabled={loading}
                                    className="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                                >
                                    {loading ? 'Generating...' : 'Generate KHQR'}
                                </button>

                                {khqrImage && (
                                    <div className="mt-8 text-center bg-white p-4 rounded-lg shadow-inner">
                                        <h3 className="text-xl font-semibold text-gray-800 mb-4">Generated KHQR Code:</h3>
                                        <img src={khqrImage} alt="Generated KHQR" className="mx-auto border border-gray-300 rounded-lg shadow-md" />
                                        <p className="mt-4 text-gray-600 text-sm">
                                            This image should be the actual QR code from Bakong. If it's a placeholder, check console for errors.
                                        </p>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Check Bakong Account Tab */}
                        {activeTab === 'checkAccount' && (
                            <div className="bg-purple-50 p-6 rounded-lg border border-purple-200">
                                <h2 className="text-2xl font-semibold text-purple-800 mb-4">Check Bakong Account Existence</h2>
                                <div className="mb-6">
                                    <label htmlFor="accountId" className="block text-gray-700 text-sm font-bold mb-2">Bakong Account ID:</label>
                                    <input
                                        type="text"
                                        id="accountId"
                                        value={accountId}
                                        onChange={(e) => setAccountId(e.target.value)}
                                        className="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-purple-500"
                                        placeholder="e.g., user@bank"
                                    />
                                </div>
                                <button
                                    onClick={checkBakongAccount}
                                    disabled={loading}
                                    className="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                                >
                                    {loading ? 'Checking...' : 'Check Account'}
                                </button>

                                {accountCheckResult && (
                                    <div className="mt-8 bg-white p-4 rounded-lg shadow-inner">
                                        <h3 className="text-xl font-semibold text-gray-800 mb-4">Account Check Result:</h3>
                                        <pre className="bg-gray-100 p-4 rounded-lg text-sm overflow-x-auto">
                                            {JSON.stringify(accountCheckResult, null, 2)}
                                        </pre>
                                        <p className="mt-4 text-gray-600 text-sm">
                                            This is the actual response from Bakong API. `responseCode: 0` means account exists.
                                        </p>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Auto Transaction Tab */}
                        {activeTab === 'autoTransaction' && (
                            <div className="bg-red-50 p-6 rounded-lg border border-red-200">
                                <h2 className="text-2xl font-semibold text-red-800 mb-4">Simulate Auto Transaction</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    <div>
                                        <label htmlFor="transactionRecipient" className="block text-gray-700 text-sm font-bold mb-2">Recipient Bakong Account ID:</label>
                                        <input
                                            type="text"
                                            id="transactionRecipient"
                                            value={transactionRecipient}
                                            onChange={(e) => setTransactionRecipient(e.target.value)}
                                            className="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-red-500"
                                            placeholder="e.g., recipient@bank"
                                        />
                                    </div>
                                    <div>
                                        <label htmlFor="transactionAmount" className="block text-gray-700 text-sm font-bold mb-2">Amount:</label>
                                        <input
                                            type="number"
                                            id="transactionAmount"
                                            value={transactionAmount}
                                            onChange={(e) => setTransactionAmount(e.target.value)}
                                            className="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-red-500"
                                            placeholder="e.g., 5.00"
                                        />
                                    </div>
                                </div>
                                <button
                                    onClick={performAutoTransaction}
                                    disabled={loading}
                                    className="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                                >
                                    {loading ? 'Processing...' : 'Perform Auto Transaction'}
                                </button>

                                {transactionResult && (
                                    <div className="mt-8 bg-white p-4 rounded-lg shadow-inner">
                                        <h3 className="text-xl font-semibold text-gray-800 mb-4">Transaction Result:</h3>
                                        <pre className="bg-gray-100 p-4 rounded-lg text-sm overflow-x-auto">
                                            {JSON.stringify(transactionResult, null, 2)}
                                        </pre>
                                        <p className="mt-4 text-gray-600 text-sm">
                                            This is a **simulated** transaction. Bakong's public API documentation does not detail a direct "auto transaction" endpoint for initiating payments.
                                        </p>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Render the App component
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
